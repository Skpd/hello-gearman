<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="assets/css/style.css"/>
    <script src="assets/js/lib.js"></script>
</head>
<body>
<div class="site-wrapper">
<div class="site-wrapper-inner">
<div class="cover-container">

    <div class="masthead clearfix">
        <div class="inner">
            <h3 class="masthead-brand">Hello, Gearman <span id="spinner" class="spinner hidden"> </span></h3>
            <ul class="nav masthead-nav">
                <li class="active"><a href="HelloGearman/Server.php">Home</a></li>
                <li><a href="../composer.json">Page A</a></li>
                <li><a href="../package.json">Page B</a></li>
            </ul>
        </div>
    </div>

    <div id="content" class="inner cover">
        <p>
            <button class="btn btn-primary" type="button" id="spawnJob">Click Me!</button>
        </p>
    </div>

    <div class="mastfoot">
        <div class="inner">
            <p>&copy; dev0 pointless research &trade; 2014<span class="pull-right">ping: <span id="ping">loading...</span></span></p>
        </div>
    </div>

</div>
</div>
</div>

<script type="text/javascript">
    var timers = {};
    var conn = new WebSocket('ws://localhost:8080');

    var Commands = {};

    Commands.Ping = function () { };
    Commands.Ping.prototype.toString = function() {
        return JSON.stringify({
            command: 'ping',
            workload: (new Date).getTime() / 1000
        });
    };

    Commands.Fetch = function(url) {
        this.url = url;
    };
    Commands.Fetch.prototype.toString = function() {
        return JSON.stringify({
            command: 'fetch',
            workload: this.url
        });
    };

    Commands.DoBackground = function(name, data, priority) {
        this.name = name;
        this.data = data;
        this.priority = priority;
    };
    Commands.DoBackground.prototype.toString = function() {
        return JSON.stringify({
            command: 'do-background',
            workload: {
                'name': this.name,
                'data': this.data,
                priority: this.priority
            }
        });
    };

    Commands.JobStatus = function(handle) {
        this.handle = handle;
    };
    Commands.JobStatus.prototype.toString = function() {
        return JSON.stringify({
            command: 'job-status',
            workload: this.handle
        });
    };

    conn.onopen = function(e) {
        console.log('connected', e);

        conn.send(new Commands.Ping());

        setInterval(function() {
            conn.send(new Commands.Ping());
        }, 15000);
    };

    conn.onmessage = function(e) {
        var response = JSON.parse(e.data);

        if (response && response.hasOwnProperty('command') && response.hasOwnProperty('workload')) {
            switch (response.command) {
                case 'pong':
                    $('#ping').text(
                        (Math.abs(response.workload - (new Date).getTime() / 1000).toFixed(6) * 1000).toFixed(2) + ' ms'
                    );
                    break;

                case 'fetch':
                    $('#content').html(response.workload);
                    $('#spinner').addClass('hidden');
                    break;

                case 'job-queued':
                    var alert = $(
                        '<div id="alert-' + response.workload.handle + '" class="alert alert-info col-md-3" role="alert">' +
                            '<span class="text">' +
                                '<strong>' + response.workload.handle + '</strong>' +
                            '</span>' +
                            '<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">0%</div></div>' +
                        '</div>'
                    );
                    $('#content').append(alert);

                    timers[response.workload.handle] = setInterval(function() {
                        conn.send(new Commands.JobStatus(response.workload.handle));
                    }, 100);
                    break;

                case 'job-status':
                    var $alert = $(document.getElementById('alert-' + response.workload.handle));

                    if (response.workload.known && !response.workload.running && !$alert.hasClass('alert-info')) {
                        $alert.removeClass('alrt-info alert-success alert-warning').addClass('alert alert-info');
                    }

                    if (response.workload.known && response.workload.running) {
                        $alert.find('.progress-bar')
                                .css('width', response.workload.numerator + '%')
                                .text(response.workload.numerator + '%')
                                .attr('aria-valuenow', response.workload.numerator);

                        if(!$alert.hasClass('alert-success')) {
                            $alert.removeClass('alert-info alert-success alert-warning').addClass('alert alert-success');
                        }
                    }

                    if (!response.workload.known && !response.workload.running && !$alert.hasClass('alert-danger')) {
                        $alert.removeClass('alert-info alert-success alert-warning').addClass('alert alert-success');
                        $alert.find('.progress-bar').css('width', '100%').text('100%').attr('aria-valuenow', 100);
                        $alert.fadeOut('slow', function() { $(this).remove(); });
                    }

                    if (!response.workload.known) {
                        clearInterval(timers[response.workload.handle]);
                        delete timers[response.workload.handle];
                    }
                    break;

                default:
                    console.log('Unknown command ', response.command);
                    break;
            }
        } else {
            console.log('Incorrect response', e.data);
        }
    };

    $('.nav a').click(function() {
        $('#spinner').removeClass('hidden');
        conn.send(new Commands.Fetch($(this).attr('href')));

        $(this).parents('.nav').find('li').removeClass('active');
        $(this).parents('li').addClass('active');
        return false;
    });

    $('#spawnJob').click(function() {
        conn.send(new Commands.DoBackground('sleep-status', 'test'));
    });
</script>
</body>
</html>