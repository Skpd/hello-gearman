<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="assets/css/style.css"/>
</head>
<body>
<div class="site-wrapper">
<div class="site-wrapper-inner">
<div class="cover-container">

    <div class="masthead clearfix">
        <div class="inner">
            <h3 class="masthead-brand">Hello, Gearman <span id="spinner" class="spinner hidden"> </span></h3>
            <ul class="nav masthead-nav">
                <li class="active"><a href="HelloGearman/Server.php">Home</a></li>
                <li><a href="../composer.json">Page A</a></li>
                <li><a href="../package.json">Page B</a></li>
            </ul>
        </div>
    </div>

    <div id="content" class="inner cover">
        <p>
            <button class="btn btn-primary" type="button" id="spawnJob">Click Me!</button>
        </p>
    </div>

    <div class="mastfoot">
        <div class="inner">
            <p>&copy; dev0 pointless research &trade; 2014<span class="pull-right">ping: <span id="ping">loading...</span></span></p>
        </div>
    </div>

</div>
</div>
</div>

<script src="assets/js/lib.js"></script>
<script type="text/javascript">
    var manager = new ConnectionManager('ws://localhost:8080');

    var doPing = function() {
        manager.send(new Commands.Ping()).done(function(data) {
            $('#ping').text((Math.abs(data - (new Date).getTime() / 1000).toFixed(6) * 1000).toFixed(2) + ' ms');
        });
    };

    manager.open().done(function() {
        doPing();
        setInterval(doPing, 10000);
    }).fail(function() {
        console.log('failed to connect');

        setTimeout(function() {
            manager.open()
        }, 5000);
    });

    $('.nav a').click(function() {
        $('#spinner').removeClass('hidden');

        $(this).parents('.nav').find('li').removeClass('active');
        $(this).parents('li').addClass('active');

        manager.send(new Commands.Fetch($(this).attr('href'))).done(function(data) {
            $('#content').html(data);
            $('#spinner').addClass('hidden');
        });
        return false;
    });

    $('#spawnJob').click(function() {
        manager.send(new Commands.RunTasks([
                    {name: 'validate-email', workload: 'dm.skpd@gmail.com'},
                    {name: 'validate-email', workload: 'skpd@ya.ru'}
                ])).done(function(data) {
            console.log('done');
        }).progress(function(data, type) {
            console.log(type, data.unique, data.numerator + '/' + data.denominator, data.data);
        });
    });
</script>
</body>
</html>