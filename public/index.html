<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="assets/css/style.css"/>
</head>
<body>
<div class="site-wrapper">
<div class="site-wrapper-inner">
<div class="cover-container">

    <div class="masthead clearfix">
        <div class="inner">
            <h3 class="masthead-brand">Hello, Gearman <span id="spinner" class="spinner hidden"> </span></h3>
            <ul class="nav masthead-nav">
                <li class="active"><a href="HelloGearman/Server.php">Home</a></li>
                <li><a href="../composer.json">Page A</a></li>
                <li><a href="../package.json">Page B</a></li>
            </ul>
        </div>
    </div>

    <div id="content" class="inner cover">
        <p>
            <button class="btn btn-primary" type="button" id="spawnJob">Click Me!</button>
        </p>
    </div>

    <div class="mastfoot">
        <div class="inner">
            <p>&copy; dev0 pointless research &trade; 2014<span class="pull-right">ping: <span id="ping">loading...</span></span></p>
        </div>
    </div>

</div>
</div>
</div>

<script src="assets/js/lib.js"></script>
<script type="text/javascript">
    var ConnectionManager = function (url) {
        var self = this;

        this.url = url;
        this.requests = {};

        this.onopen = function(e) {
            console.log('open', e);
            self.openDefer.resolve(self);
        };
        this.onmessage = function(e) {
            console.log('message', e);
        };
        this.onclose = function(e) {
            console.log('close', e);
            self.openDefer.reject(self);
        };
        this.onerror = function(e) {
            console.log('error', e);
            self.openDefer.reject(self);
        };
    };

    ConnectionManager.prototype.open = function(url) {
        url = url || this.url;

        this.openDefer = new $.Deferred;

        this.ws = new WebSocket(url);
        this.ws.onopen = this.onopen;
        this.ws.onmessage = this.onmessage;
        this.ws.onclose = this.onclose;
        this.ws.onerror = this.onerror;

        return this.openDefer.promise;
    };
    ConnectionManager.prototype.close = function(reason) {
        this.ws.close(reason);
    };
    ConnectionManager.prototype.send = function(command) {
        var key = (new Date()).getTime();

        var defer = new $.Deferred;

        this.requests[key] = defer;
        command.requestId = key;

        this.ws.send(command);

        return defer.promise;
    };

    var Commands = {};

    Commands.Ping = function () { };
    Commands.Ping.prototype.toString = function() {
        return JSON.stringify({
            command: 'ping',
            workload: (new Date).getTime() / 1000,
            requestId: this.requestId
        });
    };

    Commands.Fetch = function(url) {
        this.url = url;
    };
    Commands.Fetch.prototype.toString = function() {
        return JSON.stringify({
            command: 'fetch',
            workload: this.url,
            requestId: this.requestId
        });
    };

    Commands.DoBackground = function(name, data, priority) {
        this.name = name;
        this.data = data;
        this.priority = priority;
    };
    Commands.DoBackground.prototype.toString = function() {
        return JSON.stringify({
            command: 'do-background',
            workload: {
                name: this.name,
                data: this.data,
                priority: this.priority
            },
            requestId: this.requestId
        });
    };

    Commands.JobStatus = function(handle) {
        this.handle = handle;
    };
    Commands.JobStatus.prototype.toString = function() {
        return JSON.stringify({
            command: 'job-status',
            workload: this.handle,
            requestId: this.requestId
        });
    };

    var manager = new ConnectionManager('ws://localhost:8080');
    manager.open()().fail(function() {
        console.log('failed to connect');
    }).done(function() {
        manager.send(new Commands.Ping());
    });

    $('.nav a').click(function() {
        $('#spinner').removeClass('hidden');
        conn.send(new Commands.Fetch($(this).attr('href')));

        $(this).parents('.nav').find('li').removeClass('active');
        $(this).parents('li').addClass('active');
        return false;
    });

    $('#spawnJob').click(function() {
        conn.send(new Commands.DoBackground('sleep-status', 123, function() {
            console.log(this, arguments);
        }));
    });
</script>
</body>
</html>